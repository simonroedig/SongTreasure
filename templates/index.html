<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SongTreasure</title>
    <link rel="stylesheet" type="text/css" href="static/css/style.css">
    <link rel="stylesheet" type="text/css" href="static/css/dropdowns.css">
    <link rel="stylesheet" type="text/css" href="static/css/songs.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}">
</head>
<body>
    {% if isLoggedIn %}
        <a href="/logout">
        <button id="loginbtn">Logout ►</button>
        </a>
    {% else %}
        <a href="/login">
        <button id="loginbtn">Login ►</button>
        </a>
    {% endif %}

    <br>
    <hr id="hr1">
    <br>

    <h id="idTitle">SongTreasure</h>
    <p id="idDescr">Uncover Hidden Gems on Spotify by Genre with SongTreasure.<br>Discover Promising Tracks You Haven’t Heard Yet.</p>

    <br>
    <hr id="hr2">
    <br>

    <div id="idParameters">
        <div class="dropdown">
            <button class="dropbtn" id="dropbtnGenre">Genre 🠉</button>
            <div class="dropdown-content" id="genreOptions">
                <a class="selectItem">Select:</a>
                <a>Rock</a>
                <a>Pop</a>
                <a>Indie</a>
            </div>
        </div>
    
        <div class="dropdown">
            <button class="dropbtn" id="dropbtnSongs">Songs 🠉</button>
            <div class="dropdown-content" id="songsOptions">
                <a class="selectItem">Select:</a>
                <a>3</a>
                <a>5</a>
                <a>10</a>
                <a>20</a>
            </div>
        </div>
    </div>

    <div id="idFindWrapper">
        <button id="findbtn">► Find songs 🔎</button>
    </div>

    <div id="idTrackResults">
        {% for track in tracks %}
    
        <div class="track" onclick="playAudio('{{ loop.index0 }}')">
    
            <div class="progress-container">
                <div class="progress-circle" id="progress-{{ loop.index0 }}">
                    <button class="play-pause" data-index="{{ loop.index0 }}">{{ loop.index0 + 1 }}</button>
                </div>
            </div>
    
            <img src="{{ track.album_cover }}" alt="Album Cover">
            <audio id="audio-{{ loop.index0 }}" src="{{ track.preview_url }}"></audio>
    
            <div class="TrackInfo1">
                <div class="title">{{ track.title }}</div>
                <div class="artist">by {{ track.artist }}</div>
            </div>
    
            <div class="TrackInfo2">
                <div class="predictedPopularity">{{ track.popularity }}</div>
            </div>
    
            <div class="TrackInfo3">
                <div class="releaseDate">{{ track.release_date }}</div>
            </div>
    
            <div class="TrackInfo4">
                <div class="length">{{ track.length }}</div>
            </div>
    
        </div>
    
        {% endfor %}
    </div>
    

    <script>
        var selectedGenre = '';
        var selectedSongs = '';
        var findbtn = document.getElementById('findbtn');

        console.log("fhdsabfgadbgf");

        var isLogged = "{{ isLoggedIn }}";
        console.log(isLogged);

        document.querySelectorAll('#genreOptions a').forEach(item => {
            console.log(item);
            item.addEventListener('click', event => {
                event.preventDefault();
                selectedGenre = item.textContent;
                updateFindButton();
            });
        });

        document.querySelectorAll('#songsOptions a').forEach(item => {
            console.log(item);
            item.addEventListener('click', event => {
                event.preventDefault();
                selectedSongs = item.textContent;
                updateFindButton();
            });
        });

        function updateFindButton() {
            if (selectedGenre === "Select:") {
                selectedGenre = '';
                findbtn.style.backgroundColor = 'red';
            }
            if (selectedSongs === "Select:") {
                selectedSongs = '';
                findbtn.style.backgroundColor = 'red';
            }
            if (selectedGenre !== '' && selectedSongs !== '') {
                findbtn.style.backgroundColor = 'green';
            }
            const findButton = document.getElementById('findbtn');
            findButton.textContent = `► Find ${selectedSongs} ${selectedGenre.toLowerCase()} songs 🔎`;
        }

        function playAudio(index) {
            var audio = document.getElementById('audio-' + index);
            var track = document.querySelectorAll('.track')[index];
            var button = track.querySelector('.play-pause');
            var progressCircle = document.getElementById('progress-' + index);
            
            if (audio.paused) {
                audio.play();
                button.textContent = '❚❚';
                updateProgress(audio, progressCircle, button);
            } else {
                audio.pause();
                button.textContent = '▶';
            }
        }
        
        function updateProgress(audio, progressCircle, button) {
            var duration = audio.duration;
            var currentTime = audio.currentTime;
            var progress = (currentTime / duration) * 100;
            
            if (progress > 0) {
                progressCircle.style.background = `conic-gradient(#4caf50 ${progress}%, transparent ${progress}%)`;
            } else {
                progressCircle.style.background = 'transparent';
            }
            
            if (!audio.paused) {
                requestAnimationFrame(function() {
                    updateProgress(audio, progressCircle, button);
                });
            } else {
                button.textContent = '▶';
            }
        }
        
        document.addEventListener('play', function(e) {
            var audios = document.getElementsByTagName('audio');
            for (var i = 0, len = audios.length; i < len; i++) {
                if (audios[i] != e.target) {
                    audios[i].pause();
                    audios[i].currentTime = 0;
                    var track = audios[i].closest('.track');
                    var button = track.querySelector('.play-pause');
                    var progressCircle = track.querySelector('.progress-circle');
                    button.textContent = '▶';
                    progressCircle.style.background = 'transparent';
                }
            }
        }, true);
        
    </script>
</body>
</html>